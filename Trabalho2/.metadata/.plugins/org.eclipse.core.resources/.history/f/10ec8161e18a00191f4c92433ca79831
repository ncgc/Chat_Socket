package server;

import java.io.IOException;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.net.ServerSocket;
import java.net.Socket;

public class Server {
	private ServerSocket serverSocket; 
	
	/**
	 * O servidor fica "escutando" a porta informada. 
	 * @param Porta 
	 */
	private void criarServerSocket(int porta) throws IOException {
		this.serverSocket = new ServerSocket(porta);
		System.out.println("Aguardando conexao na porta " + porta);
	}
	
	/**
	 * O método accept() bloqueia a execução até que o servidor receba um pedido de conexão
	 * Quando o pedido é aceito, cria-se um socket entre o servidor e o cliente.
	 * @throws IOException
	 * @return socket entre servidor e cliente
	 */
	private Socket esperaConexao() throws IOException {
		Socket socket = serverSocket.accept();
		System.out.println("Connectando cliente..." + socket.getInetAddress().getHostAddress());
		return socket;
	}
	
	/**
	 * Cria streams de entrada e saída de dados entre servidor e cliente.
	 * @param socket socket que intermedia a comunicacao entre servidor e cliente
	 * @throws IOException 
	 */
	private void tratarConexao(Socket socket) throws IOException{
		try {
			ObjectOutputStream output = new ObjectOutputStream(socket.getOutputStream());
			ObjectInputStream input = new ObjectInputStream(socket.getInputStream());
			
			String msg = input.readUTF();
			System.out.println("Mensagem recebida ...");
			output.writeUTF("Hello world");
			
			input.close();
			output.close();
		} catch (IOException e) {
			e.printStackTrace();
		} finally {
			fechaSocket(socket);
		}
	}
	
	/**
	 * Finaliza um socket, desconectando o cliente conectado pelo socket informado e o servidor
	 * @param socket socket a ser finalizado
	 * @throws IOException 
	 */
	private void fechaSocket(Socket socket) throws IOException {
		socket.close();
		System.out.println("Cliente desconectado" + socket.getInetAddress().getHostAddress());
	}
	
	
	public static void main(String[] args) {
		try {
			Server server = new Server();
			
			server.criarServerSocket(2525);
			Socket socket = server.esperaConexao();
			server.tratarConexao(socket);
		}
		catch(IOException e){
			
		}
		
		

	}

}
